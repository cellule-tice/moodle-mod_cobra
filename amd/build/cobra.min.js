define(["jquery","core/log","core/templates","core/ajax","core/notification"],function(a,b,c,d,e){function f(a,b){var c=void 0==b?document.location.href:b,d=new RegExp("(\\?|&|^)"+a+"=(.*?)(&|$)"),e=c.match(d);return void 0!=e[2]?decodeURIComponent(e[2]).replace(/\+/g," "):""}function g(b,c){a("#full_concordance").hide();var d=a("#details"),e=f("id_text",document.location.href),g=a("#encode_clic").attr("name"),h=a("#userId").attr("name"),k=f("id",document.location.href);k=parseInt(k.replace("#","")),a.post("relay.php",{verb:"displayEntry",conceptid:b,resourceid:e,isexpression:c,encodeclic:g,userid:h,params:i,id:k},function(b){var c=JSON.parse(b);if(c.error)d.html(c.error);else{var e=c.html.replace(/class="label"/g,'class="cobratextlabel"').replace(/img\//g,"pix/");if(d.html(e),1==j.userglossary){var f='<span id="currentlingentity" class="hidden">'+c.lingentity+"</span>",g="",h="";"1"==c.inglossary?(g='<img height="20px" class="inGlossary" src="pix/inglossary.png" title="Pr&eacute;sent dans mon glossaire"/>',h='ng-click="addEntry('+c.lingentity+')"'):g='<img height="20px" class="glossaryAdd" src="pix/glossaryadd.png" title="Ajouter &agrave; mon glossaire"/>',a("#displayOnClic").find("tr:first").prepend("<th "+h+' class="glossaryIcon">'+f+g+"</th>").addClass("digestRow")}else a("#glossary").remove()}})}function h(b){var c=a("#full_concordance"),d=b.attr("name"),e=b.parent().parent().css("background-color"),g=f("id",document.location.href);g=parseInt(g.replace("#","")),a.post("relay.php",{verb:"displayCC",concordanceid:d,params:i,id:g},function(a){c.html(a),c.css("background-color",e),c.show()})}var i,j,k;return{init:function(c){i=c,j=JSON.parse(i),a("small").hide(),a(".hbl").hide(),a(".sbl").hide(),a.post("relay.php",{verb:"loadGlossary",id:j.cmid,textid:j.text,courseid:j.course},function(a){k=JSON.parse(a)}),b.debug("CoBRA module init")},mod_form_triggers:function(){var b=a("#id_updatelanguage"),c=a("#id_language"),d=a("#id_corpusorder"),e=a("#id_selectcollection"),f=a("#id_collection"),g=a("#id_text"),h=a("#id_name"),i=a("#id_updatedefaultdisplayprefs"),k=a("#id_isdefaultdisplayprefs"),l=a("#id_updatedefaultcorpusorder"),m=a("#id_isdefaultcorpusorder");a(b)&&a(b).css("display","none"),e&&e.css("display","none"),c.on("change",function(){var a=c.find("option:selected").text();"EN"==a?d.val(j.en):"NL"==a&&d.val(j.nl),b.trigger("click")}),f.on("change",function(){e.trigger("click")}),g.on("change",function(){""==h.val()&&h.val(a("#id_text :selected").text())}),k.on("change",function(){i.trigger("click")}),m.on("change",function(){l.trigger("click")})},entry_on_click:function(){a(".lemma").on("click",function(){a(".clicked").removeClass("clicked"),a(".emphasize").removeClass("emphasize");var b=a(this).attr("name");a(".lemma[name="+b+"]").addClass("emphasize"),a(this).removeClass("emphasize"),a(this).addClass("clicked"),g(b,!1)}),a(".expression").on("click",function(){a(".clicked").removeClass("clicked"),a(".emphasize").removeClass("emphasize");var b=a(this).attr("name");a(".expression[name="+b+"]").addClass("emphasize"),a(this).prevAll("span.expression").each(function(){return a(this).attr("name")==b&&(a(this).removeClass("emphasize"),void a(this).addClass("clicked"))}),a(this).nextAll("span.expression").each(function(){return a(this).attr("name")==b&&(a(this).removeClass("emphasize"),void a(this).addClass("clicked"))}),a(this).removeClass("emphasize"),a(this).addClass("clicked"),g(b,!0)})},concordance_on_click:function(){a("#details").on("click",".cc_source",function(){h(a(this))})},glossary_actions:function(){a("#details").on("click",".glossaryAdd",function(){var b=a(this).prev().text();a(".glossaryAdd").removeClass("glossaryAdd").addClass("inGlossary").attr("src","pix/inglossary.png").attr("title","Pr&eacute;sent dans mon glossaire");var f=d.call([{methodname:"mod_cobra_add_to_glossary",args:{lingentity:b,textid:j.text,courseid:j.course,userid:j.user}}]);f[0].done(function(b){k.push(b),k.sort(function(a,b){return a.entry<b.entry?-1:a.entry>b.entry?1:0});var d=new Array;d.entries=k,c.render("mod_cobra/intextglossary",d).done(function(b){a("#glossary").replaceWith(b)}).fail(e.exception)}).fail(e.exception)}),a("#myglossary").on("click",".glossaryRemove",function(){var b=a(this).prev().text();a(".inGlossary").removeClass("inGlossary").addClass("glossaryAdd").attr("src","pix/glossaryadd.png").attr("title","Ajouter &agrave; mon glossaire");var f=d.call([{methodname:"mod_cobra_remove_from_glossary",args:{lingentity:b,courseid:j.course,userid:j.user}}]);f[0].done(function(b){k.forEach(function(a,c){parseInt(a.ling_entity)===b.lingentity&&k.splice(c,1)});var d=new Array;d.entries=k,c.render("mod_cobra/intextglossary",d).done(function(b){a("#glossary").replaceWith(b)}).fail(e.exception)}).fail(e.exception)})}}});