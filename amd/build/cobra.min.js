define(["jquery","core/log"],function(a,b){function c(a,b){var c=void 0==b?document.location.href:b,d=new RegExp("(\\?|&|^)"+a+"=(.*?)(&|$)"),e=c.match(d);return void 0!=e[2]?decodeURIComponent(e[2]).replace(/\+/g," "):""}function d(b,d){a("#full_concordance").hide();var e=a("#details"),h=c("id_text",document.location.href),i=a("#encode_clic").attr("name"),j=a("#userId").attr("name"),k=c("id",document.location.href);k=parseInt(k.replace("#","")),a.post("relay.php",{verb:"displayEntry",conceptid:b,resourceid:h,isexpression:d,encodeclic:i,userid:j,params:f,id:k},function(b){var c=JSON.parse(b);if(c.error)e.html(c.error);else{var d=c.html.replace(/class="label"/g,'class="cobratextlabel"').replace(/img\//g,"pix/");if(e.html(d),1==g.userglossary){var f='<span id="currentlingentity" class="hidden">'+c.lingentity+"</span>",h="",i="";"1"==c.inglossary?(h='<img height="20px" class="inGlossary" src="pix/inglossary.png" title="Pr&eacute;sent dans mon glossaire"/>',i='ng-click="addEntry('+c.lingentity+')"'):h='<img height="20px" class="glossaryAdd" src="pix/glossaryadd.png" title="Ajouter &agrave; mon glossaire"/>',a("#displayOnClic").find("tr:first").prepend("<th "+i+' class="glossaryIcon">'+f+h+"</th>").addClass("digestRow")}else a("#glossary").remove()}})}function e(b){var d=a("#full_concordance"),e=b.attr("name"),g=b.parent().parent().css("background-color"),h=c("id",document.location.href);h=parseInt(h.replace("#","")),a.post("relay.php",{verb:"displayCC",concordanceid:e,params:f,id:h},function(a){d.html(a),d.css("background-color",g),d.show()})}var f,g;return{init:function(c){f=c,g=JSON.parse(f),a("small").hide(),a(".hbl").hide(),a(".sbl").hide(),b.debug("CoBRA module init")},mod_form_triggers:function(){var b=a("#id_updatelanguage"),c=a("#id_language"),d=a("#id_corpusorder"),e=a("#id_selectcollection"),f=a("#id_collection"),h=a("#id_text"),i=a("#id_name"),j=a("#id_updatedefaultdisplayprefs"),k=a("#id_isdefaultdisplayprefs"),l=a("#id_updatedefaultcorpusorder"),m=a("#id_isdefaultcorpusorder");a(b)&&a(b).css("display","none"),e&&e.css("display","none"),c.on("change",function(){var a=c.find("option:selected").text();"EN"==a?d.val(g.en):"NL"==a&&d.val(g.nl),b.trigger("click")}),f.on("change",function(){e.trigger("click")}),h.on("change",function(){""==i.val()&&i.val(a("#id_text :selected").text())}),k.on("change",function(){j.trigger("click")}),m.on("change",function(){l.trigger("click")})},entry_on_click:function(){a(".lemma").on("click",function(){a(".clicked").removeClass("clicked"),a(".emphasize").removeClass("emphasize");var b=a(this).attr("name");a(".lemma[name="+b+"]").addClass("emphasize"),a(this).removeClass("emphasize"),a(this).addClass("clicked"),d(b,!1)}),a(".expression").on("click",function(){a(".clicked").removeClass("clicked"),a(".emphasize").removeClass("emphasize");var b=a(this).attr("name");a(".expression[name="+b+"]").addClass("emphasize"),a(this).prevAll("span.expression").each(function(){return a(this).attr("name")==b&&(a(this).removeClass("emphasize"),void a(this).addClass("clicked"))}),a(this).nextAll("span.expression").each(function(){return a(this).attr("name")==b&&(a(this).removeClass("emphasize"),void a(this).addClass("clicked"))}),a(this).removeClass("emphasize"),a(this).addClass("clicked"),d(b,!0)})},concordance_on_click:function(){a("#details").on("click",".cc_source",function(){e(a(this))})},glossary_actions:function(){a("#details").on("click",".glossaryAdd",function(){var b=a(this).prev().text();a(".glossaryAdd").removeClass("glossaryAdd").addClass("inGlossary").attr("src","pix/inglossary.png").attr("title","Pr&eacute;sent dans mon glossaire"),angular.element("#bottom").scope().addEntry(b)}),a("#glossary").on("click",".glossaryRemove",function(){var b=a(this).prev().text();a(".inGlossary").removeClass("inGlossary").addClass("glossaryAdd").attr("src","pix/glossaryadd.png").attr("title","Ajouter &agrave; mon glossaire"),angular.element("#bottom").scope().removeEntry(b)})}}});