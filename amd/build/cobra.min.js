define(["jquery","core/log","core/ajax","core/templates","core/notification"],function(a,b,c,d,e){function f(b,f){a("#full_concordance").hide();var g=c.call([{methodname:"mod_cobra_get_entry",args:{concept_id:b,is_expr:f,params:i}}]);g[0].done(function(b){"bilingual"==j.examples&&(b.bilingual=!0),d.render("mod_cobra/entrydetails",b).done(function(b){a("#details").html(b)}).fail(e.exception)}).fail(e.exception)}function g(b){var f=a("#full_concordance"),g=b.attr("name"),h=c.call([{methodname:"mod_cobra_get_full_concordance",args:{id_concordance:g}}]);h[0].done(function(a){"bilingual"==j.examples&&(a.bilingual=!0),d.render("mod_cobra/fullconcordance",a).done(function(b){f.html(b),f.removeClass(),f.addClass(a.type),f.show()}).fail(e.exception)}).fail(e.exception)}function h(){var b=new Array;b.entries=k,b.cmid=j.cmid,b.course=j.course,d.render("mod_cobra/intextglossary",b).done(function(b){a("#glossary").replaceWith(b),a("#glossary").css("height",a("#cobratext").css("height"))}).fail(e.exception)}var i,j,k;return{initui:function(){a("body").hasClass("drawer-open-left")&&(a("body").removeClass("drawer-open-left"),a("#nav-drawer").attr("aria-hidden","true"),a("#nav-drawer").addClass("closed"),a('button[aria-controls="nav-drawer"]').trigger("click")),a(window).on("beforeunload",function(){}),b.debug("CoBRA module init")},initdata:function(a){i=a,j=JSON.parse(i)},mod_form_triggers:function(){var b=a("#id_updatelanguage"),c=a("#id_language"),d=a("#id_corpusorder"),e=a("#id_selectcollection"),f=a("#id_collection"),g=a("#id_text"),h=a("#id_name");c.on("change",function(){var a=c.find("option:selected").text();"EN"==a?d.val(j.en):"NL"==a&&d.val(j.nl),b.trigger("click")}),f.on("change",function(){e.trigger("click")}),g.on("change",function(){""==h.val()&&h.val(a("#id_text :selected").text())})},entry_on_click:function(){a(".lemma").on("click",function(){a(".clicked").removeClass("clicked"),a(".emphasize").removeClass("emphasize");var b=a(this).attr("name");a(".lemma[name="+b+"]").addClass("emphasize"),a(this).removeClass("emphasize"),a(this).addClass("clicked"),f(b,!1)}),a(".expression").on("click",function(){a(".clicked").removeClass("clicked"),a(".emphasize").removeClass("emphasize");var b=a(this).attr("name");a(".expression[name="+b+"]").addClass("emphasize"),a(this).prevAll("span.expression").each(function(){return a(this).attr("name")==b&&(a(this).removeClass("emphasize"),void a(this).addClass("clicked"))}),a(this).nextAll("span.expression").each(function(){return a(this).attr("name")==b&&(a(this).removeClass("emphasize"),void a(this).addClass("clicked"))}),a(this).removeClass("emphasize"),a(this).addClass("clicked"),f(b,!0)})},concordance_on_click:function(){a("#details").on("click",".cc_source",function(){g(a(this))})},text_glossary_actions:function(){var b=c.call([{methodname:"mod_cobra_load_glossary",args:{textid:j.text,courseid:j.course,userid:j.user}}]);b[0].done(function(a){k=a,h()}).fail(e.exception),a("#details").on("click",".glossaryadd",function(){var b=a(this).prev().text(),f=c.call([{methodname:"mod_cobra_add_to_glossary",args:{lingentity:b,textid:j.text,courseid:j.course,userid:j.user}}]);f[0].done(function(c){k.push(c),k.sort(function(a,b){return a.entry.toLowerCase()<b.entry.toLowerCase()?-1:a.entry.toLowerCase()>b.entry.toLowerCase()?1:0});var f=new Array;f.lingentity=b,f.iconclass="inglossary",f.add=!1,d.render("mod_cobra/glossaryiconcell",f).done(function(b){a("#displayOnClic").find("tr:first th:first").replaceWith(b)}).fail(e.exception),h()}).fail(e.exception)}),a("#myglossary").on("click",".glossaryremove",function(){var b=a(this).prev().text(),f=c.call([{methodname:"mod_cobra_remove_from_glossary",args:{lingentity:b,courseid:j.course,userid:j.user}}]);f[0].done(function(c){k.forEach(function(a,b){parseInt(a.lingentity)===c.lingentity&&k.splice(b,1)});var f=new Array;f.lingentity=b,f.iconclass="glossaryadd",f.add=!0,d.render("mod_cobra/glossaryiconcell",f).done(function(b){a("#displayOnClic").find("tr:first th:first").replaceWith(b)}).fail(e.exception),h()}).fail(e.exception)})},global_glossary_actions:function(){a("#myglossary").on("click",".glossaryremove",function(){var b=a(this).find("span:first").text(),d=a(this),f=c.call([{methodname:"mod_cobra_remove_from_glossary",args:{lingentity:b,courseid:j.course,userid:j.user}}]);f[0].done(function(c){c.lingentity==b&&a(d).hasClass("inDisplay")&&a(d.parent().remove())}).fail(e.exception)})}}});