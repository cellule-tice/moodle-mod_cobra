define(["jquery","core/log","core/templates","core/ajax","core/notification"],function(a,b,c,d,e){function f(b,f){a("#full_concordance").hide();var g=a("#details"),j=d.call([{methodname:"mod_cobra_display_entry",args:{concept_id:b,is_expr:f,params:h}}]);j[0].done(function(b){var d=b.html.replace(/class="label"/g,'class="cobralabel"').replace(/img\//g,"pix/").replace(/#FFFFCC/,"");if(g.html(d),1==i.userglossary){var f=new Array;f.lingentity=b.lingentity,1==b.inglossary?(f.iconclass="inglossary",f.add=!1):(f.iconclass="glossaryadd",f.add=!0),c.render("mod_cobra/glossaryiconcell",f).done(function(b){a("#displayOnClic").find("tr:first").prepend(b).addClass("digestRow")}).fail(e.exception)}else a("#glossary").remove()}).fail(e.exception)}function g(b){var c=a("#full_concordance"),f=b.attr("name"),g=b.parent().parent().css("background-color"),i=d.call([{methodname:"mod_cobra_get_full_concordance",args:{id_cc:f,params:h}}]);i[0].done(function(a){c.html(a.concordance),c.css("background-color",g),c.show()}).fail(e.exception)}var h,i,j;return{init:function(c){h=c,i=JSON.parse(h),a("small").hide(),a(".hbl").hide(),a(".sbl").hide(),b.debug("CoBRA module init")},mod_form_triggers:function(){var b=a("#id_updatelanguage"),c=a("#id_language"),d=a("#id_corpusorder"),e=a("#id_selectcollection"),f=a("#id_collection"),g=a("#id_text"),h=a("#id_name"),j=a("#id_updatedefaultdisplayprefs"),k=a("#id_isdefaultdisplayprefs"),l=a("#id_updatedefaultcorpusorder"),m=a("#id_isdefaultcorpusorder");a(b)&&a(b).css("display","none"),e&&e.css("display","none"),c.on("change",function(){var a=c.find("option:selected").text();"EN"==a?d.val(i.en):"NL"==a&&d.val(i.nl),b.trigger("click")}),f.on("change",function(){e.trigger("click")}),g.on("change",function(){""==h.val()&&h.val(a("#id_text :selected").text())}),k.on("change",function(){j.trigger("click")}),m.on("change",function(){l.trigger("click")})},entry_on_click:function(){a(".lemma").on("click",function(){a(".clicked").removeClass("clicked"),a(".emphasize").removeClass("emphasize");var b=a(this).attr("name");a(".lemma[name="+b+"]").addClass("emphasize"),a(this).removeClass("emphasize"),a(this).addClass("clicked"),f(b,!1)}),a(".expression").on("click",function(){a(".clicked").removeClass("clicked"),a(".emphasize").removeClass("emphasize");var b=a(this).attr("name");a(".expression[name="+b+"]").addClass("emphasize"),a(this).prevAll("span.expression").each(function(){return a(this).attr("name")==b&&(a(this).removeClass("emphasize"),void a(this).addClass("clicked"))}),a(this).nextAll("span.expression").each(function(){return a(this).attr("name")==b&&(a(this).removeClass("emphasize"),void a(this).addClass("clicked"))}),a(this).removeClass("emphasize"),a(this).addClass("clicked"),f(b,!0)})},concordance_on_click:function(){a("#details").on("click",".cc_source",function(){g(a(this))})},text_glossary_actions:function(){var b=d.call([{methodname:"mod_cobra_load_glossary",args:{textid:i.text,courseid:i.course,userid:i.user}}]);b[0].done(function(a){j=a}).fail(e.exception),a("#details").on("click",".glossaryadd",function(){var b=a(this).prev().text(),f=d.call([{methodname:"mod_cobra_add_to_glossary",args:{lingentity:b,textid:i.text,courseid:i.course,userid:i.user}}]);f[0].done(function(d){j.push(d),j.sort(function(a,b){return a.entry.toLowerCase()<b.entry.toLowerCase()?-1:a.entry.toLowerCase()>b.entry.toLowerCase()?1:0});var f=new Array;f.lingentity=b,f.iconclass="inglossary",f.add=!1,c.render("mod_cobra/glossaryiconcell",f).done(function(b){a("#displayOnClic").find("tr:first th:first").replaceWith(b)}).fail(e.exception);var f=new Array;f.entries=j,f.cmid=i.cmid,c.render("mod_cobra/intextglossary",f).done(function(b){a("#glossary").replaceWith(b)}).fail(e.exception)}).fail(e.exception)}),a("#myglossary").on("click",".glossaryremove",function(){var b=a(this).prev().text(),f=d.call([{methodname:"mod_cobra_remove_from_glossary",args:{lingentity:b,courseid:i.course,userid:i.user}}]);f[0].done(function(d){j.forEach(function(a,b){parseInt(a.ling_entity)===d.lingentity&&j.splice(b,1)});var f=new Array;f.lingentity=b,f.iconclass="glossaryadd",f.add=!0,c.render("mod_cobra/glossaryiconcell",f).done(function(b){a("#displayOnClic").find("tr:first th:first").replaceWith(b)}).fail(e.exception);var f=new Array;f.entries=j,f.cmid=i.cmid,c.render("mod_cobra/intextglossary",f).done(function(b){a("#glossary").replaceWith(b)}).fail(e.exception)}).fail(e.exception)})},global_glossary_actions:function(){a("#myglossary").on("click",".glossaryremove",function(){var b=a(this).prev().text(),c=a(this),f=d.call([{methodname:"mod_cobra_remove_from_glossary",args:{lingentity:b,courseid:i.course,userid:i.user}}]);f[0].done(function(d){d.lingentity==b&&a(c).hasClass("inDisplay")&&a(c.parent().parent().remove())}).fail(e.exception)})}}});